extends layout

block content
  .w3-card-4
    header.w3-container.w3-grey
      h1 Editar Rua #{rua.nome}

    .w3-container.w3-center
      form(method="post" action=`/editar/${rua._id}` enctype="multipart/form-data")
        input(type="hidden" name="_method" value="PUT")
        
        .w3-container
          label(for="numero") Número:
          input.w3-input(type="text", name="numero" value=rua.numero required)

        .w3-container
          label(for="nome") Nome:
          input.w3-input(type="text", name="nome" value=rua.nome required)
        
        .w3-container
          label(for="latitude") Latitude:
          input.w3-input(type="text", name="latitude" value=rua.pos.latitude required)

        .w3-container
          label(for="longitude") Longitude:
          input.w3-input(type="text", name="longitude" value=rua.pos.longitude required)
        
        .w3-container.w3-center.w3-margin-top
          hr

        // Seção para Vistas atuais
        .w3-container.w3-center
          h3
            b Vistas atuais
          .w3-row-padding.w3-margin-top.w3-center
            each figura, index in rua.figuras
              if figura.imagem.path.startsWith('../atual')
                .w3-third
                  .w3-card(id=`figura-atual-${index}`)
                    img(src=`${figura.imagem.path.slice(2)}`, style="width:100%")
                    .w3-container
                      h5= figura.legenda
                      input(type="hidden", name="figuras_atual_ids[]" value=figura._id)
                      input(type="hidden", name="figuras_atual_paths[]" value=figura.imagem.path)
                      label(for="legenda_atual") Legenda:
                      input.w3-input(type="text", name="legenda_atual[]" value=figura.legenda)
                      button.w3-button.w3-red(type="button", onclick=`removeFigura("figura-atual-${index}")`) Apagar

        .w3-container.w3-center.w3-margin-top
          hr

        // Seção para Vistas antigas
        .w3-container.w3-center
          h3
            b Vistas antigas
          .w3-row-padding.w3-margin-top.w3-center
            each figura, index in rua.figuras
              if figura.imagem.path.startsWith('../imagem')
                .w3-third
                  .w3-card(id=`figura-antiga-${index}`)
                    img(src=`${figura.imagem.path.slice(2)}`, style="width:100%")
                    .w3-container
                      h5= figura.legenda
                      input(type="hidden", name="figuras_antigas_ids[]" value=figura._id)
                      input(type="hidden", name="figuras_antigas_paths[]" value=figura.imagem.path)
                      label(for="legenda_antiga") Legenda:
                      input.w3-input(type="text", name="legenda_antiga[]" value=figura.legenda)
                      button.w3-button.w3-red(type="button", onclick=`removeFigura("figura-antiga-${index}")`) Apagar

        .w3-container.w3-center.w3-margin-top
          hr

        // Seção para upload de novas imagens
        .w3-container.w3-center.w3-margin-top
          hr
          h3
            b Upload de Novas Imagens
          .w3-section.imagem-section
            label(for="imagem") Imagem:
            input.w3-input(type="file", name="imagem" multiple)
            label(for="legenda_imagem") Legenda da Imagem:
            input.w3-input(type="text", name="legenda_imagem[]")
          
          button.w3-button.w3-green(type="button", onclick="addNovaImagem('imagem')") Adicionar Nova Imagem

          .w3-section.atual-section
            label(for="atual") Atual:
            input.w3-input(type="file", name="atual" multiple)
            label(for="legenda_atual") Legenda Atual:
            input.w3-input(type="text", name="legenda_atual[]")
          
          button.w3-button.w3-green(type="button", onclick="addNovaImagem('atual')") Adicionar Nova Vista Atual
        
        .w3-container.w3-center.w3-margin-top
          hr

        .w3-container.w3-center
          h3
            b Descrição
          .descricao-box.w3-margin-top
            textarea.w3-input(name="texto")= rua.paragrafo.texto
        
        .w3-container.w3-center.w3-margin-top
          hr

        
        .w3-container
          h3
            b Entidades
          .entidades-container
            each entidade, index in rua.paragrafo.refs.entidades
              .entidade
                input.w3-input(type="text", name=`entidades[nome][${index}]` placeholder="Nome da Entidade" value=entidade.nome)
                input.w3-input(type="text", name=`entidades[tipo][${index}]` placeholder="Tipo da Entidade" value=entidade.tipo)
          button.w3-button.w3-green(type="button", onclick="addEntidade()") Adicionar Entidade

        .w3-container.w3-center.w3-margin-top
          hr

        
        .w3-container
          h3
            b Lugares
          .lugares-container
            each lugar, index in rua.paragrafo.refs.lugares
              .lugar
                input.w3-input(type="text", name=`lugares[nome][${index}]` placeholder="Nome do Lugar" value=lugar.nome)
                input.w3-input(type="text", name=`lugares[norm][${index}]` placeholder="Norm (opcional)" value=lugar.norm)
          button.w3-button.w3-green(type="button", onclick="addLugar()") Adicionar Lugar

        .w3-container.w3-center.w3-margin-top
          hr

        .w3-container
          h3
            b Datas
          .datas-container
            each data, index in rua.paragrafo.refs.datas
              .data
                input.w3-input(type="text", name=`datas[${index}]` placeholder="Data" value=data)
          button.w3-button.w3-green(type="button", onclick="addData()") Adicionar Data

        .w3-container.w3-center.w3-margin-top
          hr

        // Seção para Casas
        .w3-container.w3-center
          h3
            b Casas
          .casas-container
            each casa, index in rua.casas
              .w3-card.w3-margin-bottom.w3-padding
                .w3-container
                  h4 Casa #{casa.numero}
                .w3-container
                  label(for="numero") Número:
                  input.w3-input(type="text", name="casas[numero][]" value=casa.numero)
                .w3-container
                  label(for="enfiteutas") Dono:
                  input.w3-input(type="text", name="casas[enfiteutas][]" value=casa.enfiteutas)
                .w3-container
                  label(for="foro") Custo:
                  input.w3-input(type="text", name="casas[foro][]" value=casa.foro)
                .w3-container
                  label(for="desc_texto") Sobre:
                  textarea.w3-input(name="casas[desc][texto][]" placeholder="Descrição")= casa.desc.texto
                .w3-container
                  label Entidades:
                  .refs-entidades-container
                    each entidade, idx in casa.desc.refs.entidades
                      input.w3-input(type="text", name=`casas[desc][refs][entidades][${index}][]` value=entidade.nome placeholder="Entidade Nome")
                      input.w3-input(type="text", name=`casas[desc][refs][entidades-tipo][${index}][]` value=entidade.tipo placeholder="Entidade Tipo")
                  button.w3-button.w3-green(type="button", onclick=`addCasaEntidade(${index}, this)`) Adicionar Entidade
                .w3-container
                  label Lugares:
                  .refs-lugares-container
                    each lugar, idx in casa.desc.refs.lugares
                      input.w3-input(type="text", name=`casas[desc][refs][lugares][${index}][]` value=lugar.nome placeholder="Lugar Nome")
                      input.w3-input(type="text", name=`casas[desc][refs][lugares-norm][${index}][]` value=lugar.norm)
                  button.w3-button.w3-green(type="button", onclick=`addCasaLugar(${index}, this)`) Adicionar Lugar
                .w3-container
                  label Datas:
                  .refs-datas-container
                    each data, idx in casa.desc.refs.datas
                      input.w3-input(type="text", name=`casas[desc][refs][datas][${index}][]` value=data placeholder="Data")
                  button.w3-button.w3-green(type="button", onclick=`addCasaData(${index}, this)`) Adicionar Data
                
          button.w3-button.w3-green(type="button", onclick="addNovaCasa()") Adicionar Nova Casa

        .w3-container.w3-center.w3-margin-top
          button.w3-button.w3-green(type="submit") Salvar
        br

    footer.w3-container.w3-grey.w3-margin-top
      h5 Generated by Group 38 in #{data}

  script.
    function addEntidade() {
      const container = document.querySelector('.entidades-container');
      const index = container.children.length / 2;
      const div = document.createElement('div');
      div.className = 'entidade';
      div.innerHTML = `
        <input class="w3-input" type="text" name="entidades[nome][${index}]" placeholder="Nome da Entidade">
        <input class="w3-input" type="text" name="entidades[tipo][${index}]" placeholder="Tipo da Entidade">
      `;
      container.appendChild(div);
    }

    function removeFigura(id) {
      console.log("Removing figure with id:", id); // Debugging line
      var element = document.getElementById(id);
      if (element) {
        element.parentNode.removeChild(element);
      } else {
        console.log("Element not found:", id); // Debugging line
      }
    }

    function addLugar() {
      const container = document.querySelector('.lugares-container');
      const index = container.children.length / 2;
      const div = document.createElement('div');
      div.className = 'lugar';
      div.innerHTML = `
        <input class="w3-input" type="text" name="lugares[nome][${index}]" placeholder="Nome do Lugar">
        <input class="w3-input" type="text" name="lugares[norm][${index}]" placeholder="Norm (opcional)">
      `;
      container.appendChild(div);
    }

    function addData() {
      const container = document.querySelector('.datas-container');
      const index = container.children.length;
      const div = document.createElement('div');
      div.className = 'data';
      div.innerHTML = `<input class="w3-input" type="text" name="datas[${index}]" placeholder="Data">`;
      container.appendChild(div);
    }

    function addNovaImagem(tipo) {
      const section = tipo === 'imagem' ? document.querySelector('.imagem-section') : document.querySelector('.atual-section');
      const inputFile = document.createElement('input');
      inputFile.type = 'file';
      inputFile.name = tipo;
      inputFile.className = 'w3-input';
      section.appendChild(inputFile);

      const inputLegenda = document.createElement('input');
      inputLegenda.type = 'text';
      inputLegenda.name = `legenda_${tipo}[]`;
      inputLegenda.className = 'w3-input';
      inputLegenda.placeholder = `Legenda ${tipo === 'imagem' ? 'da Imagem' : 'Atual'}`;
      section.appendChild(inputLegenda);
    }

    function addNovaCasa() {
      const container = document.querySelector('.casas-container');
      const index = container.children.length;
      const div = document.createElement('div');
      div.className = 'w3-card w3-margin-bottom w3-padding';
      div.innerHTML = `
        <div class="w3-container">
          <h4>Casa ${index + 1}</h4>
        </div>
        <div class="w3-container">
          <label for="numero">Número:</label>
          <input class="w3-input" type="text" name="casas[numero][]" placeholder="Número da Casa">
        </div>
        <div class="w3-container">
          <label for="enfiteutas">Dono:</label>
          <input class="w3-input" type="text" name="casas[enfiteutas][]" placeholder="Enfiteutas">
        </div>
        <div class="w3-container">
          <label for="foro">Custo:</label>
          <input class="w3-input" type="text" name="casas[foro][]" placeholder="Foro">
        </div>
        <div class="w3-container">
          <label for="desc_texto">Sobre:</label>
          <textarea class="w3-input" name="casas[desc][texto][]" placeholder="Descrição"></textarea>
        </div>
        <div class="w3-container">
          <label>Entidades:</label>
          <div class="refs-entidades-container">
            <input class="w3-input" type="text" name="casas[desc][refs][entidades][${index}][]" placeholder="Entidade Nome">
            <input class="w3-input" type="text" name="casas[desc][refs][entidades-tipo][${index}][]" placeholder="Entidade Tipo">
          </div>
          <button class="w3-button w3-green" type="button" onclick="addCasaEntidade(${index}, this)">Adicionar Entidade</button>
        </div>
        <div class="w3-container">
          <label>Lugares:</label>
          <div class="refs-lugares-container">
            <input class="w3-input" type="text" name="casas[desc][refs][lugares][${index}][]" placeholder="Lugar Nome">
            <input class="w3-input" type="text" name="casas[desc][refs][lugares-norm][${index}][]" placeholder="Lugar Norm">
          </div>
          <button class="w3-button w3-green" type="button" onclick="addCasaLugar(${index}, this)">Adicionar Lugar</button>
        </div>
        <div class="w3-container">
          <label>Datas:</label>
          <div class="refs-datas-container">
            <input class="w3-input" type="text" name="casas[desc][refs][datas][${index}][]" placeholder="Data">
          </div>
          <button class="w3-button w3-green" type="button" onclick="addCasaData(${index}, this)">Adicionar Data</button>
        </div>
      `;
      container.appendChild(div);
    }

    function addCasaEntidade(index, button) {
      var container = button.previousElementSibling;
      var div = document.createElement('div');
      div.className = 'entidade';
      div.innerHTML = `<input class="w3-input" type="text" name="casas[desc][refs][entidades][${index}][]" placeholder="Entidade Nome"><input class="w3-input" type="text" name="casas[desc][refs][entidades-tipo][${index}][]" placeholder="Entidade Tipo">`;
      container.appendChild(div);
    }

    function addCasaLugar(index, button) {
      var container = button.previousElementSibling;
      var div = document.createElement('div');
      div.className = 'lugar';
      div.innerHTML = `<input class="w3-input" type="text" name="casas[desc][refs][lugares][${index}][]" placeholder="Lugar Nome"><input class="w3-input" type="text" name="casas[desc][refs][lugares-norm][${index}][]" placeholder="Lugar Norm">`;
      container.appendChild(div);
    }

    function addCasaData(index, button) {
      var container = button.previousElementSibling;
      var div = document.createElement('div');
      div.className = 'data';
      div.innerHTML = `<input class="w3-input" type="text" name="casas[desc][refs][datas][${index}][]" placeholder="Data">`;
      container.appendChild(div);
    }
